# 命名规范-PHP

VERSION `内部版本v1.0`

遵循 PSR 标准（PHP Standard Recommendations）和行业通用规范，保持代码可读性和一致性。

---

## 1. 通用规则

- **有意义**：名称需清晰描述用途
- **避免缩写**：除非是广泛接受的缩写（如 `ID`）
- **一致性**：同一概念使用相同词汇
- **英文命名**：禁止拼音混合

---

## 2. 大小写规范

| 类型      | 规范            | 示例                         |
| --------- | --------------- | ---------------------------- |
| 类名      | PascalCase      | `UserController`             |
| 接口      | PascalCase      | `LoggerInterface`            |
| Trait     | PascalCase      | `DatabaseLoggable`           |
| 类常量    | SCREAMING_SNAKE | `MAX_LENGTH`                 |
| 方法/函数 | camelCase       | `getUserInfo()`              |
| 变量/参数 | camelCase       | `$userProfile`               |
| 普通函数  | snake_case      | `calculate_total()`          |
| 布尔变量  | is/has/can 开头 | `$isValid`, `$hasPermission` |

---

## 3. 文件与目录

- **类文件**：`类名.php` → `UserService.php`
- **目录结构**：PSR-4 自动加载规范

```text
src/
Models/
    User.php
Controllers/
    AuthController.php
```

- **配置文件**：`小写`+`下划线` → `database_config.php`

## 4. 数据库相关

| 类型   | 规范        | 示例            |
| ------ | ----------- | --------------- |
| 表名   | 复数+下划线 | `user_profiles` |
| 字段名 | 单数+下划线 | `created_at`    |
| 主键   | id          | `id`            |
| 外键   | 表名_id     | `user_id`       |
| 函数   | f_GetXXByID | `f_GetXXByID`   |
| 视图   | v_User      | `v_User`        |

## 5. 特殊约定

- `接口`：后缀 `Interface` → `CacheInterface`
- `抽象类`：前缀 `Abstract` → `AbstractModel`
- `异常`：后缀 `Exception` → `InvalidArgumentException`
- `测试类`：后缀 `Test` → `UserServiceTest`

## 6. 命名空间

- 遵循 PSR-4
- 与目录结构保持一致
- 公司/项目前缀

```php
namespace CompanyName\ProjectName\Models;
```

## 7. 禁止事项

- 保留字作标识符：❌ class, trait
- 数字开头：❌ 3DModel
- 歧义名称：❌ $data1, $data2
- 单字母变量（循环变量除外）：❌ $x, $y

## 8. 注释规范

遵循 PHPDoc 标准，保持代码可维护性和 IDE 智能提示支持

---

### 8.1. 文件头注释

```php
<?php
/**
 * 项目核心服务模块
 *
 * @package     App\Services
 * @author      John Doe <john@example.com>
 * @version     1.2.0
 * @copyright   2025 Company Name
 * @license     MIT
 */
```

### 8.2. 类注释规范

```php
/**
 * 用户账户管理服务
 *
 * 负责处理用户注册、登录、权限验证等核心业务流程
 *
 * @category    Services
 * @package     App\Services
 * @subpackage  Auth
 * @see         UserRepository
 * @since       1.1.0
 */
class UserService
{
    // ...
}
```

### 8.3. 方法/函数注释

基础格式

```php
/**
 * 用户密码验证方法
 *
 * @param  string  $username  登录用户名
 * @param  string  $password  明文密码
 * @param  bool    $remember  是否记住登录状态
 * @return int                用户ID (失败返回0)
 * @throws InvalidCredentialsException 凭证错误时抛出
 * @throws AccountLockedException     账户被锁定时抛出
 */
public function authenticate(
    string $username,
    string $password,
    bool $remember = false
): int {
    // ...
}
```

特殊标记

```php
/**
 * @deprecated 1.2.0 请使用新方法 validatePasswordStrength()
 * @internal   仅供内部身份验证使用
 * @todo       需要增加多因素认证支持
 */
```

属性/变量注释

```php
/**
 * 数据库连接实例
 *
 * @var \PDO
 */
private $database;

/**
 * 最大登录尝试次数
 *
 * @const int
 */
const MAX_LOGIN_ATTEMPTS = 5;
```

行内注释规范

```php
public function calculateDiscount(float $amount): float
{
    // 阶梯折扣计算规则
    if ($amount > 1000) {
        return $amount * 0.8;   // 20% 折扣
    } elseif ($amount > 500) {
        return $amount * 0.9;   // 10% 折扣
    }

    return $amount;  // 无折扣
}
```

特殊注释标记

| 标记      | 用途           | 示例                    |
| --------- | -------------- | ----------------------- |
| @TODO     | 待办事项       | `@TODO 缓存优化`        |
| @FIXME    | 需要修复的问题 | `@FIXME 时区处理错误`   |
| @NOTE     | 重要说明       | `@NOTE 非线程安全`      |
| @OPTIMIZE | 优化建议       | `@OPTIMIZE 减少SQL查询` |
| @REVIEW   | 需要审查的代码 | `@REVIEW 2025-03-04`    |

文档生成规范

`类型标注`：必须包含参数和返回类型

```php
/** @var int|null $userId */
```

`继承说明`：

```php
/** {@inheritdoc} */
```

`关联关系`：

```php
/** @see UserRepository::findActiveUsers() */
```

最佳实践

- 注释与代码`同步更新`
- `避免`无意义的注释
- `复杂算法`需说明`实现思路`
- `公开API`方法`必须完整注释`

## 9. 示例代码

```php
<?php
/**
 * 用户账户管理模块
 *
 * @package     App\Services
 * @author      Developer Team <dev@example.com>
 * @version     2.1.0
 * @copyright   2025 TechCorp
 * @license     MIT
 */

namespace App\Services;

use App\Exceptions\Auth\InvalidCredentialsException;
use App\Repositories\UserRepository;

/**
 * 用户认证与权限管理服务
 *
 * 处理用户登录、权限验证、会话管理等核心业务流程
 *
 * @category    Services
 * @package     App\Services\Auth
 * @see         UserRepository
 * @since       2.0.0
 */
class UserAuthService
{
    /**
     * 数据库连接实例
     *
     * @var \PDO
     */
    private $dbConnection;

    /**
     * 允许的最大登录尝试次数
     *
     * @const int
     */
    const MAX_LOGIN_ATTEMPTS = 5;

    /**
     * 初始化认证服务
     *
     * @param \PDO $dbConnection 数据库连接对象
     */
    public function __construct(\PDO $dbConnection)
    {
        $this->dbConnection = $dbConnection;
    }

    /**
     * 用户登录认证方法
     *
     * @param  string  $username  登录用户名（3-20位字母数字）
     * @param  string  $password  明文密码（最少8位）
     * @param  bool    $remember  是否保持长期登录状态
     * @return int                 用户ID
     * @throws InvalidCredentialsException 当认证失败时抛出
     * @throws \RuntimeException          数据库操作失败时抛出
     *
     * @todo 需要增加二次验证支持
     * @since 2.1.0 新增$remember参数
     */
    public function authenticate(
        string $username,
        string $password,
        bool $remember = false
    ): int {
        // 输入有效性基础检查
        if (empty($username) || empty($password)) {
            throw new \InvalidArgumentException("用户名和密码不能为空");
        }

        // 获取用户记录（使用预处理语句防止SQL注入）
        $stmt = $this->dbConnection->prepare(
            "SELECT id, password_hash FROM users WHERE username = :username"
        );
        $stmt->execute([':username' => $username]);
        $user = $stmt->fetch();

        if (!$user || !password_verify($password, $user['password_hash'])) {
            throw new InvalidCredentialsException("无效的用户名或密码");
        }

        return (int)$user['id'];
    }

    /**
     * 密码强度验证方法（旧版）
     *
     * @deprecated 2.0.0 请使用新方法 validatePasswordPolicy()
     * @param  string $password 待验证密码
     * @return bool
     */
    public function checkPasswordStrength(string $password): bool
    {
        return strlen($password) >= 6;
    }

    /**
     * 计算用户等级折扣
     *
     * @internal 仅限订单模块调用
     * @param  int   $userId    用户ID
     * @param  float $amount    原始金额
     * @return float            折扣后金额
     *
     * @FIXME 折扣计算未考虑用户历史订单量
     * @OPTIMIZE 需要缓存用户等级信息
     */
    public function calculateDiscount(int $userId, float $amount): float
    {
        // 获取用户等级（1-5级）
        $userLevel = $this->getUserLevel($userId);

        // 阶梯折扣计算规则
        if ($userLevel >= 5) {
            return $amount * 0.7;   // 30% 折扣
        } elseif ($userLevel >= 3) {
            return $amount * 0.85;  // 15% 折扣
        }

        return $amount;  // 无折扣
    }

    /**
     * 生成安全随机令牌
     *
     * @param  int    $length  令牌长度（默认32）
     * @return string          十六进制格式令牌
     *
     * @NOTE 使用openssl扩展生成密码学安全随机数
     */
    private function generateSecureToken(int $length = 32): string
    {
        return bin2hex(random_bytes($length));
    }
}
```
